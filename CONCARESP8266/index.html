<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêi·ªÅu Khi·ªÉn Xe Wi-Fi</title>
    <!-- T·∫£i Tailwind CSS ƒë·ªÉ t·∫°o giao di·ªán responsive v√† hi·ªán ƒë·∫°i -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ƒê√É S·ª¨A L·ªñI: T·∫£i Font Awesome 6.5.2 M·ªöI NH·∫§T, s·ª≠a l·ªói c√∫ ph√°p xintegrity th√†nh integrity -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJz9R3iWCRpS9wQ4vYfA8BfQ01x6A/wB7G3P1S3UaJ7L21q5o0k5L4Z7J3q8w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* T√πy ch·ªânh font Inter */
        html { font-family: 'Inter', sans-serif; }
        
        /* ƒê·∫£m b·∫£o c√°c n√∫t ho·∫°t ƒë·ªông t·ªët tr√™n thi·∫øt b·ªã c·∫£m ·ª©ng */
        .control-button {
            transition: background-color 0.1s ease, box-shadow 0.1s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        /* Phong c√°ch m·ªõi cho c√°c n√∫t ƒëi·ªÅu khi·ªÉn khi nh·∫•n */
        .control-button:active {
            transform: none; 
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.8); /* Hi·ªáu ·ª©ng l√µm v√†o */
            background-color: #0d0d0d; /* N·ªÅn r·∫•t t·ªëi khi nh·∫•n */
            color: #fff;
        }

        /* KHU V·ª∞C D-PAD M·ªöI (H√åNH VU√îNG) */
        .dpad-container {
            position: relative;
            max-width: 300px; /* Gi·ªõi h·∫°n k√≠ch th∆∞·ªõc D-Pad */
            width: 100%;
            aspect-ratio: 1 / 1;
            margin: auto;
            background-color: #262626; /* M√†u n·ªÅn x√°m ƒë·∫≠m bao quanh D-Pad */
            border-radius: 8px; /* Bo g√≥c nh·∫π cho container vu√¥ng */
            padding: 4px; /* Kho·∫£ng ƒë·ªám nh·ªè b√™n trong */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        /* B·ªë c·ª•c D-Pad 9 √¥: S·ª≠ d·ª•ng Grid ƒë·ªÉ ƒë·ªãnh v·ªã c√°c n√∫t */
        .dpad-grid {
            /* B·ªë c·ª•c ti√™u chu·∫©n 3x3 */
            grid-template-areas: 
                "K F M" /* Ti·∫øn Xoay Tr√°i (K) | Ti·∫øn (F) | Ti·∫øn Xoay Ph·∫£i (M) */
                "L S R" /* Xoay Tr√°i (L) | D·ª´ng (S) | Xoay Ph·∫£i (R) */
                "N B O"; /* L√πi Xoay Tr√°i (N) | L√πi (B) | L√πi Xoay Ph·∫£i (O) */

            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 4px; /* Kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
            width: 100%;
            height: 100%;
        }
        
        /* ƒê·ªãnh v·ªã v√† M√†u s·∫Øc c√°c n√∫t */
        .control-button {
            background-color: #333333; /* M√†u n·ªÅn n√∫t x√°m ƒë·∫≠m */
            border-radius: 4px; /* Bo g√≥c nh·∫π cho c√°c n√∫t */
            color: #e0e0e0; /* M√†u ch·ªØ/bi·ªÉu t∆∞·ª£ng tr·∫Øng s√°ng */
            border: none; /* Lo·∫°i b·ªè border */
            font-size: 2rem;
            display: flex; /* D√πng flex ƒë·ªÉ cƒÉn gi·ªØa icon */
            align-items: center;
            justify-content: center;
            padding: 0; /* B·ªè padding m·∫∑c ƒë·ªãnh */
        }

        /* N√∫t STOP ·ªü gi·ªØa (N·ªïi b·∫≠t) */
        .dpad-grid button:nth-child(5) { 
            background-color: #e30000; /* ƒê·ªè t∆∞∆°i - STOP */ 
            border-radius: 50%; /* N√∫t STOP tr√≤n */
            font-size: 1.8rem; /* K√≠ch th∆∞·ªõc icon STOP nh·ªè h∆°n ch√∫t */
            color: #ffffff; /* M√†u tr·∫Øng cho bi·ªÉu t∆∞·ª£ng STOP */
        }
        .dpad-grid button:nth-child(5):active {
             background-color: #a00000; /* ƒê·ªè ƒë·∫≠m h∆°n khi nh·∫•n */
        }

        /* Bi·ªÉu t∆∞·ª£ng cho n√∫t Ti·∫øn/L√πi Th·∫≥ng v√† 4 n√∫t ch√©o */
        .dpad-grid button i { 
            font-size: 2.2rem; /* K√≠ch th∆∞·ªõc icon th·ªëng nh·∫•t */
        }

        /* ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc icon xoay ƒë·ªÉ ph√π h·ª£p */
        .dpad-grid button[data-cmd="L"] i, .dpad-grid button[data-cmd="R"] i {
            font-size: 2rem; /* Nh·ªè h∆°n ch√∫t cho icon xoay */
        }
        
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col p-4">

    <!-- Header --><header class="text-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">
            <i class="fas fa-car mr-2 text-indigo-600"></i> ƒêi·ªÅu Khi·ªÉn Xe Wi-Fi
        </h1>
    </header>

    <!-- C·∫•u h√¨nh v√† Tr·∫°ng th√°i --><div class="max-w-xl mx-auto w-full bg-white p-6 rounded-xl shadow-lg mb-6">
        <label for="ipAddress" class="block text-sm font-medium text-gray-700 mb-1">
            <i class="fas fa-network-wired mr-1"></i> ƒê·ªãa Ch·ªâ IP c·ªßa ESP8266 (V√≠ d·ª•: 192.168.1.100)
        </label>
        <input type="text" id="ipAddress" value="192.168.1.100" class="w-full border-gray-300 border rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ IP...">
        
        <div class="mt-4 flex justify-between items-center">
             <div class="flex items-center">
                <i class="fas fa-gauge-high mr-2 text-green-600"></i>
                <span class="text-sm font-medium text-gray-700">T·ªëc ƒê·ªô Hi·ªán T·∫°i:</span>
            </div>
            <select id="speedSelect" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 p-2.5">
                <option value="9">T·ªëi ƒêa (1023)</option>
                <option value="7" selected>Cao (890)</option>
                <option value="5">Trung B√¨nh (750)</option>
                <option value="3">Th·∫•p (610)</option>
                <option value="0">T·ªëi Thi·ªÉu (400)</option>
            </select>
        </div>

        <p id="statusMessage" class="mt-4 text-center font-semibold text-sm h-5 text-gray-500"></p>
    </div>

    <!-- Khu V·ª±c ƒêi·ªÅu Khi·ªÉn Ch√≠nh (D-Pad H√¨nh Vu√¥ng) --><main class="flex-grow flex items-center justify-center">
        <div class="w-full">
            <div class="dpad-container"> 
                <div class="dpad-grid grid w-full h-full">

                    <!-- H√†ng 1: TI·∫æN & XOAY (K, F, M) --><!-- 1. Ti·∫øn Xoay Tr√°i (Forward Rotate Left - K) -->
                    <button data-cmd="K" class="control-button">
                        <i class="fas fa-arrow-up-left"></i> 
                    </button>
                    
                    <!-- 2. Ti·∫øn (Forward - F) -->
                    <button id="btn-F" data-cmd="F" class="control-button">
                        <i class="fas fa-arrow-up"></i>
                    </button>

                    <!-- 3. Ti·∫øn Xoay Ph·∫£i (Forward Rotate Right - M) -->
                    <button data-cmd="M" class="control-button">
                        <i class="fas fa-arrow-up-right"></i> 
                    </button>

                    <!-- H√†ng 2: XOAY T·∫†I CH·ªñ (L, S, R) --><!-- 4. Xoay Tr√°i t·∫°i ch·ªó (Go Left - L) -->
                    <button data-cmd="L" class="control-button">
                        <i class="fas fa-undo-alt"></i> <!-- Bi·ªÉu t∆∞·ª£ng quay ng∆∞·ª£c -->
                    </button>

                    <!-- 5. D·ª™NG (STOP - S) -->
                    <button id="btn-S" data-cmd="S" class="control-button">
                        <i class="fas fa-stop"></i>
                    </button>

                    <!-- 6. Xoay Ph·∫£i t·∫°i ch·ªó (Go Right - R) -->
                    <button data-cmd="R" class="control-button">
                        <i class="fas fa-redo-alt"></i> <!-- Bi·ªÉu t∆∞·ª£ng quay xu√¥i -->
                    </button>

                    <!-- H√†ng 3: L√ôI & XOAY (N, B, O) --><!-- 7. L√πi Xoay Tr√°i (Back Rotate Left - N) -->
                    <button data-cmd="N" class="control-button">
                        <i class="fas fa-arrow-down-left"></i> 
                    </button>

                    <!-- 8. L√πi (Back - B) -->
                    <button id="btn-B" data-cmd="B" class="control-button">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                    
                    <!-- 9. L√πi Xoay Ph·∫£i (Back Rotate Right - O) -->
                    <button data-cmd="O" class="control-button">
                        <i class="fas fa-arrow-down-right"></i> 
                    </button>

                </div>
            </div>
        </div>
    </main>

    <script>
        // L·∫•y c√°c tham chi·∫øu ƒë·∫øn c√°c ph·∫ßn t·ª≠ DOM
        const ipInput = document.getElementById('ipAddress');
        const statusMessage = document.getElementById('statusMessage');
        const speedSelect = document.getElementById('speedSelect');
        const controlButtons = document.querySelectorAll('.control-button');

        // Bi·∫øn l∆∞u tr·ªØ tr·∫°ng th√°i (d√πng cho vi·ªác gi·ªØ n√∫t)
        let currentCommand = null;
        let pressTimer = null;
        let statusClearTimer = null; // Bi·∫øn ƒë·ªÉ qu·∫£n l√Ω vi·ªác t·ª± ƒë·ªông x√≥a tr·∫°ng th√°i

        // --- H√†m G·ª≠i L·ªánh ƒêi·ªÅu Khi·ªÉn ---
        function sendCommand(command) {
            const ip = ipInput.value.trim();
            if (!ip) {
                updateStatus("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ IP c·ªßa ESP8266.", 'text-red-500', false); // Kh√¥ng t·ª± ƒë·ªông x√≥a l·ªói n√†y
                return;
            }

            const url = `http://${ip}/?State=${command}`;

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i ngay l·∫≠p t·ª©c ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt l·ªánh ƒëang ƒë∆∞·ª£c g·ª≠i
            updateStatus(`‚è≥ ƒêang g·ª≠i l·ªánh: ${command} ƒë·∫øn ${ip}...`, 'text-yellow-600', true); 
            
            // S·ª¨ D·ª§NG XMLHttpRequest (XHR) ƒê·ªÇ TƒÇNG T√çNH T∆Ø∆†NG TH√çCH V·ªöI M√îI TR∆Ø·ªúNG LOCAL
            const xhr = new XMLHttpRequest();
            xhr.open('GET', url, true); // true cho asynchronous
            
            xhr.onload = function() {
                // X·ª≠ l√Ω khi y√™u c·∫ßu ho√†n th√†nh (bao g·ªìm c·∫£ l·ªói 4xx, 5xx)
                if (xhr.status === 0 || (xhr.status >= 200 && xhr.status < 400)) {
                     // C·∫≠p nh·∫≠t tr·∫°ng th√°i hi·ªÉn th·ªã
                    let statusText = `G·ª≠i l·ªánh: ${command}`;
                    
                    // N·∫øu l√† l·ªánh t·ªëc ƒë·ªô (0-9)
                    if (!isNaN(parseInt(command)) && command.length === 1) {
                         const speedValue = speedSelect.options[speedSelect.selectedIndex].text;
                         statusText = `Thay ƒë·ªïi T·ªëc ƒê·ªô: ${speedValue} (${command})`;
                    }
                    updateStatus(`‚úÖ ${statusText}`, 'text-green-600', true);
                } else {
                    // N·∫øu server tr·∫£ v·ªÅ l·ªói HTTP (4xx, 5xx)
                    updateStatus(`‚ùå L·ªói HTTP: ${xhr.status}`, 'text-red-500', false);
                    console.error(`L·ªói HTTP khi g·ª≠i l·ªánh ${command}:`, xhr.status);
                }
            };
            
            xhr.onerror = function() {
                // X·ª≠ l√Ω l·ªói m·∫°ng ho·∫∑c l·ªói kh√¥ng th·ªÉ k·∫øt n·ªëi
                updateStatus(`‚ùå L·ªói k·∫øt n·ªëi ho·∫∑c IP sai! (Ki·ªÉm tra xem ESP ƒë√£ b·∫≠t v√† c√πng m·∫°ng ch∆∞a)`, 'text-red-500', false);
                console.error("L·ªói m·∫°ng/k·∫øt n·ªëi khi g·ª≠i l·ªánh:", command);
            };

            xhr.send();
        }

        // --- H√†m C·∫≠p Nh·∫≠t Tr·∫°ng Th√°i ---
        function updateStatus(message, colorClass = 'text-gray-500', autoClear = false) {
            // X√≥a b·ªô ƒë·∫øm c≈©
            if (statusClearTimer) {
                clearTimeout(statusClearTimer);
                statusClearTimer = null;
            }

            statusMessage.textContent = message;
            statusMessage.className = `mt-4 text-center font-semibold text-sm h-5 ${colorClass}`;

            // T·ª± ƒë·ªông x√≥a tr·∫°ng th√°i n·∫øu autoClear l√† true
            if (autoClear) {
                statusClearTimer = setTimeout(() => {
                    statusMessage.textContent = '';
                    statusMessage.className = `mt-4 text-center font-semibold text-sm h-5 text-gray-500`;
                }, 3000); // Gi·ªØ tin nh·∫Øn 3 gi√¢y
            }
        }

        // --- Logic X·ª≠ L√Ω Gi·ªØ v√† Nh·∫£ N√∫t ---

        // 1. Nh·∫•n N√∫t (touchstart/mousedown)
        function handlePress(event) {
            event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh (nh∆∞ cu·ªôn tr√™n mobile)
            
            // X√≥a l·ªánh d·ª´ng ƒëang ch·ªù
            if (pressTimer) {
                clearTimeout(pressTimer);
            }

            const button = event.currentTarget;
            const command = button.getAttribute('data-cmd');

            // G·ª≠i l·ªánh khi b·∫Øt ƒë·∫ßu nh·∫•n
            if (currentCommand !== command) {
                currentCommand = command;
                sendCommand(command);
            }
        }

        // 2. Nh·∫£ N√∫t (touchend/mouseup/mouseleave)
        function handleRelease(event) {
            event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh
            
            // Ch·ªâ g·ª≠i l·ªánh STOP n·∫øu l·ªánh tr∆∞·ªõc ƒë√≥ KH√îNG ph·∫£i l√† STOP ho·∫∑c l·ªánh T·ªëc ƒë·ªô
            const isSpeedCommand = !isNaN(parseInt(currentCommand)) && currentCommand.length === 1;

            if (currentCommand && currentCommand !== 'S' && !isSpeedCommand) {
                
                // ƒê·∫∑t th·ªùi gian ch·ªù ng·∫Øn tr∆∞·ªõc khi g·ª≠i l·ªánh STOP (S)
                pressTimer = setTimeout(() => {
                    sendCommand('S'); // G·ª≠i l·ªánh D·ª™NG
                    currentCommand = 'S';
                    updateStatus("‚èπÔ∏è ƒê√£ d·ª´ng xe (L·ªánh S)", 'text-red-500', true); 
                }, 50); // ƒê·ªô tr·ªÖ 50ms
            }
        }

        // --- G·∫Øn S·ª± Ki·ªán Cho C√°c N√∫t ƒêi·ªÅu Khi·ªÉn ---
        controlButtons.forEach(button => {
            // S·ª± ki·ªán cho Desktop
            button.addEventListener('mousedown', handlePress);
            button.addEventListener('mouseup', handleRelease);
            button.addEventListener('mouseleave', handleRelease);

            // S·ª± ki·ªán cho Mobile/Touch
            button.addEventListener('touchstart', handlePress, { passive: false });
            button.addEventListener('touchend', handleRelease, { passive: false });
            button.addEventListener('touchcancel', handleRelease, { passive: false });
        });

        // --- X·ª≠ L√Ω Thay ƒê·ªïi T·ªëc ƒê·ªô ---
        speedSelect.addEventListener('change', (event) => {
            const speedCommand = event.target.value; // L·∫•y gi√° tr·ªã l·ªánh (0-9)
            sendCommand(speedCommand);
        });
        
        // --- Thi·∫øt l·∫≠p m·∫∑c ƒë·ªãnh khi t·∫£i trang ---
        window.onload = () => {
             // T·ª± ƒë·ªông g·ª≠i l·ªánh t·ªëc ƒë·ªô m·∫∑c ƒë·ªãnh khi t·∫£i trang (v√≠ d·ª•: l·ªánh '7' cho t·ªëc ƒë·ªô 890)
             // ƒê·∫£m b·∫£o l·ªánh n√†y ƒë∆∞·ª£c g·ª≠i sau khi t·∫•t c·∫£ c√°c tham chi·∫øu DOM ƒë∆∞·ª£c thi·∫øt l·∫≠p.
             if(speedSelect.value) {
                sendCommand(speedSelect.value); 
             }
             // Khuy·∫øn ngh·ªã s·ª≠ d·ª•ng IP c·ªßa ESP8266 ƒë√£ k·∫øt n·ªëi
             updateStatus(`üõ†Ô∏è S·∫µn s√†ng. Nh·∫≠p IP v√† b·∫Øt ƒë·∫ßu ƒëi·ªÅu khi·ªÉn.`, 'text-indigo-500', true);
        };
    </script>
</body>
</html>
